<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>HalachaHelper</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,400;0,600;1,400&family=Frank+Ruhl+Libre:wght@400;500;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            parchment: '#f4f1ea',
            parchmentDark: '#e8e4d9',
            sepia: '#5c4a37',
            sepiaLight: '#8b7355',
            gold: '#b8860b',
            goldLight: '#d4a84b',
            navy: '#1a237e',
            navyLight: '#3949ab',
          },
          fontFamily: {
            serif: ['Crimson Pro', 'Georgia', 'serif'],
            hebrew: ['Frank Ruhl Libre', 'serif'],
          }
        }
      }
    }
  </script>
  <style>
    @keyframes spin { to { transform: rotate(360deg); } }
    .animate-spin { animation: spin 1s linear infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .animate-pulse { animation: pulse 2s ease-in-out infinite; }

    body {
      background: linear-gradient(180deg, #f4f1ea 0%, #e8e4d9 100%);
      background-attachment: fixed;
    }

    .paper-texture {
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noiseFilter'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noiseFilter)'/%3E%3C/svg%3E");
      background-blend-mode: soft-light;
      background-size: 200px 200px;
    }

    .card-ornate {
      border: 1px solid #d4c5a9;
      box-shadow:
        0 1px 3px rgba(92, 74, 55, 0.1),
        inset 0 0 20px rgba(244, 241, 234, 0.5);
    }

    .star-divider::before {
      content: "âœ¡";
      display: block;
      text-align: center;
      color: #b8860b;
      font-size: 1rem;
      opacity: 0.6;
      margin: 0.5rem 0;
    }

    .hebrew-text {
      font-family: 'Frank Ruhl Libre', serif;
      line-height: 1.8;
    }

    .header-ornate {
      border-bottom: 2px solid #b8860b;
      background: linear-gradient(180deg, #1a237e 0%, #283593 100%);
    }

    .source-card {
      background: linear-gradient(135deg, #fdfcf9 0%, #f4f1ea 100%);
      border-left: 3px solid #b8860b;
    }

    .progress-step {
      transition: all 0.3s ease;
    }
    .progress-step.active {
      color: #1a237e;
      font-weight: 600;
    }
    .progress-step.complete {
      color: #166534;
    }
    .progress-step.pending {
      color: #8b7355;
      opacity: 0.6;
    }

    @media (max-width: 640px) {
      input[type="text"] { font-size: 16px; }
      button, a { min-height: 44px; display: inline-flex; align-items: center; }
      .text-xs.rounded-full { min-height: 32px; }
    }

    html { scroll-behavior: smooth; }
    * { -webkit-tap-highlight-color: transparent; }
  </style>
</head>
<body class="min-h-screen font-serif">
  <div id="app"></div>

  <script>
    // ===========================================
    // STATE
    // ===========================================
    let state = {
      query: '',
      result: null,
      loading: false,
      loadingPhase: null, // 'triage' | 'search' | 'reason'
      error: null,
      expandedSources: {},
      // Multi-turn conversation state
      conversation: {
        phase: null, // null | 'needs_context' | 'needs_clarification' | 'complete'
        sessionState: null,
        contextQuestions: [],
        contextAnswers: [],
        clarifications: []
      },
      // User/Auth state
      user: JSON.parse(localStorage.getItem('halachaHelper_user') || 'null'),
      showLoginModal: false,
      // Feedback state
      showFeedbackModal: false,
      feedbackSubmitting: false,
      feedbackSuccess: false,
      feedbackError: null
    };

    // ===========================================
    // API CALLS
    // ===========================================
    async function askQuestion(question, context = null, sessionState = null) {
      const response = await fetch('/api/ask', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ question, context, sessionState })
      });

      if (!response.ok) {
        const error = await response.json();
        throw new Error(error.error || 'Failed to get answer');
      }

      return await response.json();
    }

    // ===========================================
    // MAIN PROCESSING
    // ===========================================
    async function processQuestion(question, context = null, sessionState = null) {
      // Show triage phase
      state.loadingPhase = 'triage';
      render();

      const result = await askQuestion(question, context, sessionState);

      // If we need context, return early
      if (result.phase === 'needs_context' || result.phase === 'needs_clarification') {
        return result;
      }

      // Otherwise it went through all phases
      return result;
    }

    async function handleSearch() {
      if (!state.query.trim()) return;

      state.loading = true;
      state.error = null;
      state.result = null;
      state.expandedSources = {};
      state.conversation = {
        phase: null,
        sessionState: null,
        contextQuestions: [],
        contextAnswers: [],
        clarifications: []
      };
      render();

      try {
        const result = await processQuestion(state.query);

        if (result.phase === 'needs_context') {
          state.conversation.phase = 'needs_context';
          state.conversation.sessionState = result.sessionState;
          state.conversation.contextQuestions = result.contextQuestions || [];
          state.loading = false;
        } else if (result.phase === 'needs_clarification') {
          state.conversation.phase = 'needs_clarification';
          state.conversation.sessionState = result.sessionState;
          state.conversation.clarifications = result.clarifications || [];
          state.loading = false;
        } else {
          state.result = result;
          state.conversation.phase = 'complete';
          state.loading = false;
        }
      } catch (e) {
        state.error = e.message;
        state.loading = false;
        console.error(e);
      }

      render();
    }

    async function handleContextSubmit() {
      // Gather answers from the form
      const answers = [];
      state.conversation.contextQuestions.forEach((q, i) => {
        const input = document.getElementById(`context-answer-${i}`);
        // Handle both string and object formats
        const questionText = typeof q === 'string' ? q : (q.question || q);
        if (input && input.value.trim()) {
          answers.push({
            question: questionText,
            answer: input.value.trim()
          });
        }
      });

      if (answers.length === 0) {
        alert('Please answer at least one question');
        return;
      }

      state.loading = true;
      state.loadingPhase = 'search';
      state.conversation.contextAnswers = answers;
      render();

      try {
        // Mark context as complete and continue
        const sessionState = {
          ...state.conversation.sessionState,
          contextComplete: true
        };

        const result = await askQuestion(state.query, answers, sessionState);
        state.result = result;
        state.conversation.phase = 'complete';
        state.loading = false;
      } catch (e) {
        state.error = e.message;
        state.loading = false;
        console.error(e);
      }

      render();
    }

    async function handleClarificationSubmit(clarifiedQuestion) {
      state.query = clarifiedQuestion;
      state.conversation = {
        phase: null,
        sessionState: null,
        contextQuestions: [],
        contextAnswers: [],
        clarifications: []
      };
      await handleSearch();
    }

    function setQuery(value) {
      state.query = value;
      const input = document.getElementById('searchInput');
      if (input) input.value = value;
    }

    function toggleSource(ref) {
      state.expandedSources[ref] = !state.expandedSources[ref];
      render();
    }

    // Collapsible sections state
    let expandedSections = {
      reasoning: false,
      sources: false
    };

    function toggleSection(section) {
      expandedSections[section] = !expandedSections[section];
      render();
    }

    // ===========================================
    // USER/AUTH FUNCTIONS
    // ===========================================
    function showLogin() {
      state.showLoginModal = true;
      render();
    }

    function hideLogin() {
      state.showLoginModal = false;
      render();
    }

    function logout() {
      state.user = null;
      localStorage.removeItem('halachaHelper_user');
      render();
    }

    async function handleLogin(email) {
      try {
        const response = await fetch('/api/feedback', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ action: 'login', email })
        });

        const data = await response.json();

        if (!response.ok) {
          alert(data.error || 'Login failed');
          return;
        }

        state.user = data.user;
        localStorage.setItem('halachaHelper_user', JSON.stringify(data.user));
        state.showLoginModal = false;
        render();
      } catch (e) {
        console.error('Login error:', e);
        alert('Login failed. Please try again.');
      }
    }

    // ===========================================
    // FEEDBACK FUNCTIONS
    // ===========================================
    function showFeedbackModal() {
      state.showFeedbackModal = true;
      state.feedbackSuccess = false;
      state.feedbackError = null;
      render();
    }

    function hideFeedbackModal() {
      state.showFeedbackModal = false;
      state.feedbackSuccess = false;
      state.feedbackError = null;
      render();
    }

    async function submitFeedback() {
      const issueType = document.getElementById('feedback-issue-type')?.value;
      const correction = document.getElementById('feedback-correction')?.value;
      const notes = document.getElementById('feedback-notes')?.value;

      if (!issueType) {
        state.feedbackError = 'Please select an issue type';
        render();
        return;
      }

      state.feedbackSubmitting = true;
      state.feedbackError = null;
      render();

      try {
        const response = await fetch('/api/feedback', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            action: 'submit',
            question: state.query,
            response: state.result,
            issueType,
            correction,
            notes,
            userId: state.user?.id,
            userName: state.user?.name || state.user?.email
          })
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Failed to submit feedback');
        }

        state.feedbackSubmitting = false;
        state.feedbackSuccess = true;
        render();

        // Auto-close after success
        setTimeout(() => {
          hideFeedbackModal();
        }, 2000);

      } catch (e) {
        state.feedbackSubmitting = false;
        state.feedbackError = e.message;
        render();
      }
    }

    // ===========================================
    // ICONS
    // ===========================================
    const icons = {
      search: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>`,
      check: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`,
      chevronDown: `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>`,
      chevronUp: `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"></path></svg>`,
      external: `<svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path></svg>`,
      loader: `<svg class="w-5 h-5 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>`,
      question: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`,
      book: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253"></path></svg>`,
      scale: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 6l3 1m0 0l-3 9a5.002 5.002 0 006.001 0M6 7l3 9M6 7l6-2m6 2l3-1m-3 1l-3 9a5.002 5.002 0 006.001 0M18 7l3 9m-3-9l-6-2m0-2v2m0 16V5m0 16H9m3 0h3"></path></svg>`,
      flag: `<svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 21v-4m0 0V5a2 2 0 012-2h6.5l1 1H21l-3 6 3 6h-8.5l-1-1H5a2 2 0 00-2 2zm9-13.5V9"></path></svg>`,
      user: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>`,
      close: `<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>`
    };

    // ===========================================
    // RENDER
    // ===========================================
    function render() {
      const app = document.getElementById('app');

      app.innerHTML = `
        <!-- Header -->
        <header class="header-ornate text-white shadow-lg">
          <div class="max-w-3xl mx-auto px-4 py-4 sm:py-5">
            <div class="flex items-center justify-between">
              <div class="w-20"></div>
              <div class="flex items-center justify-center gap-2 sm:gap-3">
                <span class="text-goldLight text-sm sm:text-base">âœ¡</span>
                <div class="text-center">
                  <h1 class="text-xl sm:text-2xl font-semibold tracking-wide">HalachaHelper</h1>
                  <p class="text-xs text-blue-200 tracking-widest uppercase">Source-Based Halachic Research</p>
                </div>
                <span class="text-goldLight text-sm sm:text-base">âœ¡</span>
              </div>
              <div class="w-20 flex justify-end">
                ${state.user ? `
                  <div class="flex items-center gap-2">
                    <span class="text-xs text-blue-200 hidden sm:inline">${state.user.name || state.user.email}</span>
                    ${state.user.role === 'rabbi' ? '<span class="text-xs px-1.5 py-0.5 bg-gold/30 text-goldLight rounded">Rabbi</span>' : ''}
                    <button onclick="logout()" class="text-xs text-blue-200 hover:text-white underline">Logout</button>
                  </div>
                ` : `
                  <button onclick="showLogin()" class="text-blue-200 hover:text-white flex items-center gap-1 text-xs">
                    ${icons.user} <span class="hidden sm:inline">Login</span>
                  </button>
                `}
              </div>
            </div>
          </div>
        </header>

        <!-- Login Modal -->
        ${state.showLoginModal ? renderLoginModal() : ''}

        <!-- Feedback Modal -->
        ${state.showFeedbackModal ? renderFeedbackModal() : ''}

        <main class="max-w-3xl mx-auto px-3 sm:px-4 py-4 sm:py-8">

          <!-- Search Card -->
          <div class="card-ornate bg-white rounded-lg p-4 sm:p-6 mb-4 sm:mb-8 paper-texture">
            <div class="text-center mb-4">
              <p class="text-sepia text-xs sm:text-sm italic">"Ask, and it shall be given you; seek, and ye shall find"</p>
            </div>

            <div class="flex flex-col sm:flex-row gap-3">
              <input
                type="text"
                id="searchInput"
                value="${state.query.replace(/"/g, '&quot;')}"
                placeholder="Ask a question about Jewish law..."
                class="flex-1 px-4 py-3 border-2 border-parchmentDark rounded-lg focus:ring-2 focus:ring-gold focus:border-gold outline-none text-sepia bg-parchment placeholder-sepiaLight text-base"
                ${state.loading ? 'disabled' : ''}
              />
              <button
                id="searchBtn"
                ${state.loading ? 'disabled' : ''}
                class="px-6 py-3 bg-navy text-white rounded-lg font-medium hover:bg-navyLight disabled:bg-sepiaLight flex items-center justify-center gap-2 transition-colors min-h-[48px]"
              >
                ${state.loading ? icons.loader : icons.search}
                ${state.loading ? 'Searching...' : 'Ask'}
              </button>
            </div>

            <div class="mt-4 flex flex-wrap justify-center gap-2">
              <span class="text-xs text-sepiaLight hidden sm:inline">Try:</span>
              <button onclick="setQuery('Can I eat dairy after chicken?')" class="text-xs px-3 py-1.5 bg-parchment text-sepia rounded-full hover:bg-parchmentDark border border-parchmentDark transition-colors">dairy after chicken</button>
              <button onclick="setQuery('What bracha do I make on granola?')" class="text-xs px-3 py-1.5 bg-parchment text-sepia rounded-full hover:bg-parchmentDark border border-parchmentDark transition-colors">bracha on granola</button>
              <button onclick="setQuery('Can I say Kiddush Levana through a window?')" class="text-xs px-3 py-1.5 bg-parchment text-sepia rounded-full hover:bg-parchmentDark border border-parchmentDark transition-colors">Kiddush Levana</button>
            </div>
          </div>

          <!-- Loading with Progress Steps -->
          ${state.loading ? renderLoadingProgress() : ''}

          <!-- Context Questions (Multi-turn) -->
          ${state.conversation.phase === 'needs_context' && !state.loading ? renderContextQuestions() : ''}

          <!-- Clarification Needed -->
          ${state.conversation.phase === 'needs_clarification' && !state.loading ? renderClarifications() : ''}

          <!-- Error -->
          ${state.error ? `
            <div class="card-ornate bg-red-50 border-red-300 rounded-lg p-4 mb-6 text-red-800">
              <strong>Error:</strong> ${state.error}
            </div>
          ` : ''}

          <!-- Results -->
          ${state.result && !state.loading ? renderResult(state.result) : ''}

          <!-- Empty state -->
          ${!state.result && !state.loading && !state.error && !state.conversation.phase ? `
            <div class="text-center py-10 sm:py-16 text-sepiaLight">
              <div class="mb-4 text-gold text-3xl sm:text-4xl">âœ¡</div>
              <p class="text-base sm:text-lg text-sepia mb-2">Ask a question about Jewish law or practice</p>
              <p class="text-xs sm:text-sm mb-4">Now with source-driven reasoning from Sefaria</p>
              <div class="text-xs text-sepiaLight max-w-md mx-auto">
                <p class="mb-2">This tool searches actual halachic texts, applies proper methodology, and will refuse to answer without sources.</p>
              </div>
            </div>
          ` : ''}

        </main>

        <!-- Footer -->
        <footer class="max-w-3xl mx-auto px-4 py-4 sm:py-6 text-center">
          <div class="star-divider"></div>
          <p class="text-xs text-sepiaLight">
            Sources from <a href="https://www.sefaria.org" target="_blank" class="text-sepia hover:text-gold underline">Sefaria</a> Â·
            Not a substitute for rabbinic guidance
          </p>
        </footer>
      `;

      // Event listeners
      const input = document.getElementById('searchInput');
      const btn = document.getElementById('searchBtn');
      if (input) {
        input.addEventListener('input', e => state.query = e.target.value);
        input.addEventListener('keydown', e => { if (e.key === 'Enter' && !state.loading) handleSearch(); });
      }
      if (btn) {
        btn.addEventListener('click', handleSearch);
      }

      // Context submit button
      const contextBtn = document.getElementById('contextSubmitBtn');
      if (contextBtn) {
        contextBtn.addEventListener('click', handleContextSubmit);
      }
    }

    function renderLoadingProgress() {
      const phases = [
        { key: 'triage', label: 'Analyzing question...', icon: icons.question },
        { key: 'search', label: 'Searching sources...', icon: icons.book },
        { key: 'reason', label: 'Applying halachic reasoning...', icon: icons.scale }
      ];

      const currentIndex = phases.findIndex(p => p.key === state.loadingPhase);

      return `
        <div class="card-ornate bg-white rounded-lg p-6 sm:p-8 paper-texture">
          <div class="space-y-4">
            ${phases.map((phase, i) => {
              let status = 'pending';
              if (i < currentIndex) status = 'complete';
              else if (i === currentIndex) status = 'active';

              return `
                <div class="flex items-center gap-3 progress-step ${status}">
                  <div class="w-6 h-6 flex items-center justify-center">
                    ${status === 'active' ? icons.loader :
                      status === 'complete' ? `<span class="text-green-600">âœ“</span>` :
                      `<span class="text-sepiaLight">â—‹</span>`}
                  </div>
                  <span class="text-sm sm:text-base">${phase.label}</span>
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
    }

    function renderContextQuestions() {
      const triage = state.conversation.sessionState?.triage;

      return `
        <div class="card-ornate bg-white rounded-lg overflow-hidden paper-texture">
          <div class="px-4 sm:px-5 py-3 bg-amber-50 border-b border-amber-200">
            <div class="flex items-center gap-2">
              <span class="text-amber-600">${icons.question}</span>
              <span class="font-semibold text-amber-900">Additional Information Needed</span>
            </div>
          </div>

          <div class="p-4 sm:p-6">
            ${triage?.initialAssessment ? `
              <p class="text-sepia mb-4">${triage.initialAssessment}</p>
            ` : ''}

            <p class="text-sepiaLight text-sm mb-4">To provide an accurate ruling, I need to understand your specific situation:</p>

            <div class="space-y-4">
              ${state.conversation.contextQuestions.map((q, i) => {
                // Handle both string and object formats
                const questionText = typeof q === 'string' ? q : (q.question || q);
                const whyText = typeof q === 'object' ? q.why : null;
                const options = typeof q === 'object' ? q.options : null;
                return `
                <div class="border border-parchmentDark rounded-lg p-4 bg-parchment">
                  <label class="block text-sepia font-medium mb-2">${questionText}</label>
                  ${whyText ? `<p class="text-xs text-sepiaLight mb-2">Why this matters: ${whyText}</p>` : ''}
                  ${options && options.length > 0 ? `
                    <select id="context-answer-${i}" class="w-full px-3 py-2 border border-parchmentDark rounded bg-white text-sepia">
                      <option value="">Select an option...</option>
                      ${options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                    </select>
                  ` : `
                    <input
                      type="text"
                      id="context-answer-${i}"
                      class="w-full px-3 py-2 border border-parchmentDark rounded bg-white text-sepia"
                      placeholder="Your answer..."
                    />
                  `}
                </div>
              `}).join('')}
            </div>

            <div class="mt-6 flex gap-3">
              <button
                id="contextSubmitBtn"
                class="px-6 py-3 bg-navy text-white rounded-lg font-medium hover:bg-navyLight flex items-center gap-2"
              >
                Continue ${icons.chevronDown}
              </button>
              <button
                onclick="state.conversation.phase = null; render();"
                class="px-4 py-3 text-sepiaLight hover:text-sepia"
              >
                Cancel
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function renderClarifications() {
      return `
        <div class="card-ornate bg-white rounded-lg overflow-hidden paper-texture">
          <div class="px-4 sm:px-5 py-3 bg-blue-50 border-b border-blue-200">
            <div class="flex items-center gap-2">
              <span class="text-blue-600">${icons.question}</span>
              <span class="font-semibold text-blue-900">Clarification Needed</span>
            </div>
          </div>

          <div class="p-4 sm:p-6">
            <p class="text-sepia mb-4">Your question could be interpreted in different ways:</p>

            <ul class="list-disc list-inside space-y-2 text-sepia mb-6">
              ${state.conversation.clarifications.map(c => `<li>${c}</li>`).join('')}
            </ul>

            <p class="text-sepiaLight text-sm mb-4">Please rephrase your question to be more specific:</p>

            <input
              type="text"
              id="clarifiedInput"
              class="w-full px-4 py-3 border-2 border-parchmentDark rounded-lg text-sepia bg-parchment"
              value="${state.query.replace(/"/g, '&quot;')}"
            />

            <div class="mt-4">
              <button
                onclick="handleClarificationSubmit(document.getElementById('clarifiedInput').value)"
                class="px-6 py-3 bg-navy text-white rounded-lg font-medium hover:bg-navyLight"
              >
                Search Again
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function renderResult(result) {
      // No sources found
      if (result.noSourcesFound) {
        return `
          <div class="card-ornate bg-white rounded-lg overflow-hidden paper-texture">
            <div class="px-4 sm:px-5 py-3 bg-orange-50 border-b border-orange-200">
              <div class="flex items-center gap-2">
                <span class="text-orange-600">${icons.book}</span>
                <span class="font-semibold text-orange-900">No Sources Found</span>
              </div>
            </div>
            <div class="p-4 sm:p-6">
              <p class="text-sepia">${result.answer}</p>
              ${result.sourcesSearched ? `
                <div class="mt-4 pt-4 border-t border-parchmentDark">
                  <p class="text-xs text-sepiaLight">Searched for: ${[
                    ...(result.sourcesSearched.hebrewTermsUsed || []),
                    ...(result.sourcesSearched.englishTermsUsed || [])
                  ].join(', ') || 'N/A'}</p>
                </div>
              ` : ''}
            </div>
          </div>
        `;
      }

      // Must defer to rabbi
      if (result.mustDeferToRabbi || !result.canAnswer) {
        return renderDeferResult(result);
      }

      // Full answer
      return renderFullAnswer(result);
    }

    function renderDeferResult(result) {
      return `
        <div class="card-ornate bg-white rounded-lg overflow-hidden paper-texture">
          <div class="px-4 sm:px-5 py-3 sm:py-4 bg-amber-50 border-b border-amber-200 flex flex-wrap items-center gap-2 sm:gap-3">
            <span class="text-amber-600 text-lg sm:text-xl">ðŸ‘¤</span>
            <span class="font-semibold text-amber-900 text-sm sm:text-base">Consult a Rabbi</span>
            ${result.domain ? `
              <span class="ml-auto text-xs px-3 py-1 bg-amber-100 text-amber-800 rounded-full font-medium">
                ${result.domain.name}
              </span>
            ` : ''}
          </div>

          <div class="p-4 sm:p-6">
            <p class="text-sepia text-base sm:text-lg leading-relaxed mb-6">${result.answer}</p>

            ${result.reasoning && result.reasoning.length > 0 ? `
              <div class="pt-4 sm:pt-6 border-t border-parchmentDark">
                <h3 class="text-xs font-semibold text-sepiaLight uppercase tracking-widest mb-4 flex items-center gap-2">
                  <span class="text-gold">â€”</span> Relevant Background <span class="text-gold">â€”</span>
                </h3>
                <div class="space-y-3">
                  ${result.reasoning.map(step => `
                    <div class="source-card rounded p-3 sm:p-4">
                      <div class="text-xs font-semibold text-gold uppercase tracking-wide mb-2">${step.level}</div>
                      <p class="text-sepia leading-relaxed text-sm">${step.text || step.analysis}</p>
                      ${step.source ? `
                        <a href="https://www.sefaria.org/${step.source.replace(/ /g, '_')}" target="_blank"
                           class="mt-2 text-sm text-navy hover:text-navyLight flex items-center gap-1">
                          ðŸ“œ ${step.source} ${icons.external}
                        </a>
                      ` : ''}
                    </div>
                  `).join('')}
                </div>
              </div>
            ` : ''}
          </div>
        </div>
      `;
    }

    function renderFullAnswer(result) {
      // Handle both old format (reasoning array) and new format (interpretationChain)
      const hasNewFormat = result.interpretationChain && result.interpretationChain.length > 0;
      const hasOldFormat = result.reasoning && result.reasoning.length > 0;

      return `
        <div class="card-ornate bg-white rounded-lg overflow-hidden paper-texture">

          <!-- Header with domain and confidence -->
          <div class="px-4 sm:px-5 py-3 bg-parchment border-b border-parchmentDark flex flex-wrap items-center justify-between gap-2">
            <div class="flex items-center gap-2">
              ${result.domain ? `
                <span class="text-xs px-3 py-1 bg-navy text-white rounded-full font-medium">
                  ${result.domain.name}
                </span>
                <span class="text-xs text-sepiaLight hidden sm:inline">${result.domain.translation || ''}</span>
              ` : ''}
              ${result.ruling?.level ? `
                <span class="text-xs px-2 py-0.5 bg-gold/20 text-sepia rounded">
                  ${result.ruling.level === 'd_oraita' ? 'Biblical' :
                    result.ruling.level === 'd_rabbanan' ? 'Rabbinic' : 'Custom'}
                </span>
              ` : ''}
            </div>
            <div class="flex items-center gap-3 text-xs text-sepiaLight">
              <div class="flex items-center gap-2">
                <span class="w-2 h-2 rounded-full ${result.confidence >= 90 ? 'bg-green-600' : result.confidence >= 70 ? 'bg-gold' : 'bg-orange-500'}"></span>
                ${result.confidence}% confidence
                ${result.sourcesFound ? `Â· ${result.sourcesFound} sources` : ''}
              </div>
              ${state.user?.role === 'rabbi' ? `
                <button
                  onclick="showFeedbackModal()"
                  class="flex items-center gap-1 px-2 py-1 text-amber-700 bg-amber-50 hover:bg-amber-100 rounded border border-amber-200 transition-colors"
                  title="Flag an issue with this response"
                >
                  ${icons.flag} Flag Issue
                </button>
              ` : ''}
            </div>
          </div>

          <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
          <!-- SECTION 1: THE RULING (Always Visible) -->
          <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
          <div class="p-4 sm:p-6 border-b border-parchmentDark">
            <div class="flex gap-3 sm:gap-4">
              <div class="w-7 h-7 sm:w-8 sm:h-8 rounded-full bg-green-100 flex items-center justify-center text-green-700 flex-shrink-0 mt-0.5">
                ${icons.check}
              </div>
              <div class="min-w-0">
                <p class="text-sepia text-base sm:text-lg leading-relaxed">${result.answer}</p>
                ${result.ruling?.summary ? `
                  <p class="mt-3 text-sm text-navy font-medium">${result.ruling.summary}</p>
                ` : ''}
              </div>
            </div>

            <!-- Chabad Note (inline with ruling) -->
            ${result.chabadNote ? `
              <div class="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-100">
                <p class="text-sm text-navy"><strong>Chabad Practice:</strong> ${result.chabadNote}</p>
              </div>
            ` : ''}

            <!-- Consult Rabbi Note -->
            ${result.consultRabbi ? `
              <div class="mt-4 p-3 bg-amber-50 rounded-lg border border-amber-200">
                <p class="text-sm text-amber-800"><strong>Consult a rabbi if:</strong> ${result.consultRabbi}</p>
              </div>
            ` : ''}
          </div>

          <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
          <!-- SECTION 2: REASONING PROCESS (Collapsible) -->
          <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
          <div class="border-b border-parchmentDark">
            <button
              onclick="toggleSection('reasoning')"
              class="w-full px-4 sm:px-6 py-4 flex items-center justify-between hover:bg-parchment/50 transition-colors"
            >
              <h3 class="text-sm font-semibold text-sepia flex items-center gap-2">
                ${icons.scale}
                <span>How We Got Here</span>
                <span class="text-xs font-normal text-sepiaLight">(Reasoning Process)</span>
              </h3>
              <span class="text-sepiaLight">${expandedSections.reasoning ? icons.chevronUp : icons.chevronDown}</span>
            </button>

            ${expandedSections.reasoning ? `
              <div class="px-4 sm:px-6 pb-6">
                <!-- Understanding the Question -->
                ${result.thinkingProcess ? `
                  <div class="mb-4 p-3 bg-blue-50/50 rounded-lg">
                    <div class="text-xs font-semibold text-navy uppercase tracking-wide mb-1">Understanding the Question</div>
                    <p class="text-sm text-sepia">${result.thinkingProcess.understandingTheQuestion || ''}</p>
                    ${result.thinkingProcess.keyHalachicIssue ? `
                      <p class="text-sm text-navy mt-2"><strong>Key Issue:</strong> ${result.thinkingProcess.keyHalachicIssue}</p>
                    ` : ''}
                  </div>
                ` : ''}

                <!-- Interpretation Chain (New Format) -->
                ${hasNewFormat ? `
                  <div class="space-y-3">
                    <div class="text-xs font-semibold text-sepiaLight uppercase tracking-wide mb-2">Tracing Through Sources</div>
                    ${result.interpretationChain.map((step, i) => `
                      <div class="source-card rounded p-3 sm:p-4 ${step.agreesOrDisagrees === 'disagrees' ? 'border-l-amber-500' : step.agreesOrDisagrees === 'qualifies' || step.agreesOrDisagrees === 'adds_exception' ? 'border-l-blue-500' : ''}">
                        <div class="flex items-center gap-2 mb-2">
                          <span class="text-xs font-semibold text-gold uppercase tracking-wide">${step.sourceLevel}</span>
                          ${step.agreesOrDisagrees === 'disagrees' ? '<span class="text-xs px-2 py-0.5 bg-amber-100 text-amber-700 rounded">Disagrees</span>' :
                            step.agreesOrDisagrees === 'qualifies' ? '<span class="text-xs px-2 py-0.5 bg-blue-100 text-blue-700 rounded">Qualifies</span>' :
                            step.agreesOrDisagrees === 'adds_exception' ? '<span class="text-xs px-2 py-0.5 bg-blue-100 text-blue-700 rounded">Exception</span>' : ''}
                        </div>
                        ${step.position ? `<p class="text-sepia leading-relaxed text-sm mb-2 italic">"${step.position}"</p>` : ''}
                        ${step.significance ? `<p class="text-sepia leading-relaxed text-sm">${step.significance}</p>` : ''}
                        ${step.source ? `
                          <p class="mt-2 text-xs text-navy">ðŸ“œ ${step.source}</p>
                        ` : ''}
                      </div>
                    `).join('')}
                  </div>
                ` : ''}

                <!-- Old Format Fallback -->
                ${!hasNewFormat && hasOldFormat ? `
                  <div class="space-y-3">
                    ${result.reasoning.map(step => `
                      <div class="source-card rounded p-3 sm:p-4">
                        <div class="text-xs font-semibold text-gold uppercase tracking-wide mb-2">${step.level}</div>
                        ${step.text ? `<p class="text-sepia leading-relaxed text-sm mb-2 italic">"${step.text}"</p>` : ''}
                        ${step.analysis ? `<p class="text-sepia leading-relaxed text-sm">${step.analysis}</p>` : ''}
                        ${step.source ? `<p class="mt-2 text-xs text-navy">ðŸ“œ ${step.source}</p>` : ''}
                      </div>
                    `).join('')}
                  </div>
                ` : ''}

                <!-- Application -->
                ${result.application ? `
                  <div class="mt-4 p-3 bg-green-50/50 rounded-lg border border-green-100">
                    <div class="text-xs font-semibold text-green-800 uppercase tracking-wide mb-1">Application</div>
                    <p class="text-sm text-sepia">${result.application.howApplied || ''}</p>
                    ${result.application.circumstances ? `
                      <p class="text-sm text-sepiaLight mt-2"><em>This ruling would change if: ${result.application.circumstances}</em></p>
                    ` : ''}
                  </div>
                ` : ''}
              </div>
            ` : ''}
          </div>

          <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
          <!-- SECTION 3: SOURCES (Collapsible) -->
          <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
          ${(result.sourceTexts && Object.keys(result.sourceTexts).length > 0) || (result.sources && result.sources.length > 0) ? `
            <div class="border-b border-parchmentDark">
              <button
                onclick="toggleSection('sources')"
                class="w-full px-4 sm:px-6 py-4 flex items-center justify-between hover:bg-parchment/50 transition-colors"
              >
                <h3 class="text-sm font-semibold text-sepia flex items-center gap-2">
                  ${icons.book}
                  <span>View Sources</span>
                  <span class="text-xs font-normal text-sepiaLight">(${result.sourcesFound || Object.keys(result.sourceTexts || {}).length} texts)</span>
                </h3>
                <span class="text-sepiaLight">${expandedSections.sources ? icons.chevronUp : icons.chevronDown}</span>
              </button>

              ${expandedSections.sources ? `
                <div class="px-4 sm:px-6 pb-6 space-y-4">
                  ${Object.entries(result.sourceTexts || {}).map(([ref, source]) => `
                    <div class="source-card rounded p-4">
                      <div class="flex items-center justify-between mb-3">
                        <span class="font-medium text-sepia">${ref}</span>
                        <a
                          href="https://www.sefaria.org/${ref.replace(/ /g, '_')}"
                          target="_blank"
                          class="text-xs text-navy hover:text-navyLight flex items-center gap-1"
                        >
                          Sefaria ${icons.external}
                        </a>
                      </div>
                      ${source.english ? `
                        <div class="mb-3">
                          <div class="text-xs font-semibold text-sepiaLight uppercase tracking-wide mb-1">English</div>
                          <div class="text-sepia leading-relaxed text-sm">${source.english.substring(0, 500)}${source.english.length > 500 ? '...' : ''}</div>
                        </div>
                      ` : ''}
                      ${source.hebrew ? `
                        <div>
                          <div class="text-xs font-semibold text-sepiaLight uppercase tracking-wide mb-1">Hebrew</div>
                          <div class="text-sepia leading-relaxed text-right hebrew-text text-sm" dir="rtl">${source.hebrew.substring(0, 500)}${source.hebrew.length > 500 ? '...' : ''}</div>
                        </div>
                      ` : ''}
                    </div>
                  `).join('')}
                </div>
              ` : ''}
            </div>
          ` : ''}

          <!-- Jargon Glossary -->
          ${result.jargon && result.jargon.length > 0 ? `
            <div class="px-4 sm:px-6 py-3 sm:py-4 bg-parchment">
              <div class="text-xs sm:text-sm text-sepia">
                <span class="font-semibold text-sepiaLight block sm:inline mb-1 sm:mb-0">Terms:</span>
                <span class="block sm:inline">
                  ${result.jargon.map(j => `
                    <span class="inline-block mr-2 sm:ml-2 sm:mr-0" title="${j.explanation || ''}">
                      <em class="text-navy">${j.term}</em> = ${j.translation}
                    </span>
                  `).join('<span class="hidden sm:inline"> Â· </span>')}
                </span>
              </div>
            </div>
          ` : ''}
        </div>
      `;
    }

    // ===========================================
    // MODAL RENDERS
    // ===========================================
    function renderLoginModal() {
      return `
        <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onclick="if(event.target === this) hideLogin()">
          <div class="bg-white rounded-lg shadow-xl max-w-md w-full paper-texture card-ornate">
            <div class="px-6 py-4 border-b border-parchmentDark flex items-center justify-between">
              <h3 class="font-semibold text-sepia">Rabbi Login</h3>
              <button onclick="hideLogin()" class="text-sepiaLight hover:text-sepia">${icons.close}</button>
            </div>
            <div class="p-6">
              <p class="text-sm text-sepiaLight mb-4">Login to provide feedback on responses. Only authorized rabbis can flag issues.</p>
              <div class="space-y-4">
                <div>
                  <label class="block text-sm font-medium text-sepia mb-1">Email Address</label>
                  <input
                    type="email"
                    id="login-email"
                    class="w-full px-4 py-2 border border-parchmentDark rounded-lg bg-parchment text-sepia"
                    placeholder="your@email.com"
                  />
                </div>
                <button
                  onclick="handleLogin(document.getElementById('login-email').value)"
                  class="w-full px-4 py-3 bg-navy text-white rounded-lg font-medium hover:bg-navyLight"
                >
                  Login
                </button>
              </div>
              <p class="text-xs text-sepiaLight mt-4 text-center">Contact administrator to get access.</p>
            </div>
          </div>
        </div>
      `;
    }

    function renderFeedbackModal() {
      if (state.feedbackSuccess) {
        return `
          <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
            <div class="bg-white rounded-lg shadow-xl max-w-md w-full paper-texture card-ornate p-8 text-center">
              <div class="text-green-600 text-4xl mb-4">âœ“</div>
              <h3 class="font-semibold text-sepia text-lg mb-2">Feedback Submitted</h3>
              <p class="text-sepiaLight">Thank you for helping improve HalachaHelper.</p>
            </div>
          </div>
        `;
      }

      return `
        <div class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4" onclick="if(event.target === this) hideFeedbackModal()">
          <div class="bg-white rounded-lg shadow-xl max-w-lg w-full paper-texture card-ornate max-h-[90vh] overflow-y-auto">
            <div class="px-6 py-4 border-b border-parchmentDark flex items-center justify-between sticky top-0 bg-white">
              <h3 class="font-semibold text-sepia flex items-center gap-2">
                ${icons.flag} Flag Issue with Response
              </h3>
              <button onclick="hideFeedbackModal()" class="text-sepiaLight hover:text-sepia">${icons.close}</button>
            </div>
            <div class="p-6">
              <!-- Original Question Summary -->
              <div class="mb-4 p-3 bg-parchment rounded-lg">
                <div class="text-xs font-semibold text-sepiaLight uppercase mb-1">Question</div>
                <p class="text-sm text-sepia">${state.query}</p>
              </div>

              ${state.feedbackError ? `
                <div class="mb-4 p-3 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm">
                  ${state.feedbackError}
                </div>
              ` : ''}

              <div class="space-y-4">
                <!-- Issue Type -->
                <div>
                  <label class="block text-sm font-medium text-sepia mb-1">Issue Type *</label>
                  <select
                    id="feedback-issue-type"
                    class="w-full px-4 py-2 border border-parchmentDark rounded-lg bg-white text-sepia"
                  >
                    <option value="">Select issue type...</option>
                    <option value="incorrect_conclusion">Incorrect Conclusion - The final ruling is wrong</option>
                    <option value="misapplied_source">Misapplied Source - Source cited but used incorrectly</option>
                    <option value="missing_source">Missing Source - Key source not referenced</option>
                    <option value="reasoning_flaw">Reasoning Flaw - Logic or methodology error</option>
                    <option value="other">Other</option>
                  </select>
                </div>

                <!-- Correction -->
                <div>
                  <label class="block text-sm font-medium text-sepia mb-1">What should the correct answer be?</label>
                  <textarea
                    id="feedback-correction"
                    rows="3"
                    class="w-full px-4 py-2 border border-parchmentDark rounded-lg bg-parchment text-sepia"
                    placeholder="Provide the correct ruling or interpretation..."
                  ></textarea>
                </div>

                <!-- Notes -->
                <div>
                  <label class="block text-sm font-medium text-sepia mb-1">Additional Notes</label>
                  <textarea
                    id="feedback-notes"
                    rows="2"
                    class="w-full px-4 py-2 border border-parchmentDark rounded-lg bg-parchment text-sepia"
                    placeholder="Any other context or sources to consider..."
                  ></textarea>
                </div>

                <!-- Submit -->
                <div class="flex gap-3 pt-2">
                  <button
                    onclick="submitFeedback()"
                    ${state.feedbackSubmitting ? 'disabled' : ''}
                    class="flex-1 px-4 py-3 bg-navy text-white rounded-lg font-medium hover:bg-navyLight disabled:bg-sepiaLight flex items-center justify-center gap-2"
                  >
                    ${state.feedbackSubmitting ? icons.loader + ' Submitting...' : 'Submit Feedback'}
                  </button>
                  <button
                    onclick="hideFeedbackModal()"
                    class="px-4 py-3 border border-parchmentDark text-sepia rounded-lg hover:bg-parchment"
                  >
                    Cancel
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      `;
    }

    // Initial render
    render();
  </script>
</body>
</html>
